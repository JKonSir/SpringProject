<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Integration Logs</title>
    <link rel="stylesheet" href="css/jquery.datetimepicker.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="javascript/jquery.datetimepicker.full.js"></script>
    <script type="text/javascript">
        $(document).ready(function () {
            $.get("/integration-log",
                  function (data) {
                      var table = document.createElement('table');
                      table.setAttribute('id', 'table');
                      var tableBody = buildTableBody(data);
                      table.appendChild(tableBody);
                      var body = document.getElementsByTagName('body')[0];
                      body.appendChild(table);
                  });
        });
    </script>
    <script type="text/javascript">

        function showPopup(title, contentID) {
            document.getElementById('popupHeader').innerHTML = title;
            var p = document.getElementById(contentID);
            document.getElementById('popupDescr').innerHTML = p.innerHTML;
            document.getElementById('popupModal').style.display = 'block';
        }

        window.onclick = function (event) {
            var popupModal = document.getElementById('popupModal');
            if (event.target == popupModal) {
                popupModal.style.display = 'none';
            }
        };

        function submitForm() {
            var from = $('#from').val();
            var to = $('#to').val();

            var fromTimestamp = !!new Date(from).getTime() ? new Date(from).getTime() : 0;
            var toTimestamp = !!new Date(to).getTime() ? new Date(to).getTime()
                                                       : new Date().getTime();

            if (fromTimestamp > toTimestamp) {
                showError('integration_log',
                          '"From" cannot be more then "to"');
                return;
            }

            var getUrl = "/integration-log?" + "interval=[" + fromTimestamp + ", " + toTimestamp
                         + "]";

            $.get(getUrl,
                  function (data) {
                      $('#table').empty();

                      var tableBody = buildTableBody(data);
                      $('#table').append(tableBody);
                      // var table = buildTable(data);
                      // // $('#table').load('integrationLog.html #table');
                      // var body = document.getElementsByTagName('body')[0];
                      // body.
                  });
        }

        function showError(field, errorMessage) {
            var errorSpan = document.createElement("span");
            var errorMessage = document.createTextNode(errorMessage);

            errorSpan.appendChild(errorMessage);
            errorSpan.className = "errorMsg";

            var fieldLabel = document.getElementById(field).previousSibling;
            while (fieldLabel.nodeName.toLowerCase() != "label") {
                fieldLabel = fieldLabel.previousSibling;
            }
            fieldLabel.appendChild(errorSpan);
        }

        function buildTableBody(data) {

            // var body = document.getElementsByTagName('body')[0];
            // var table = document.createElement('table');
            // table.setAttribute('id', 'table');
            var tableBody = document.createElement('tableBody');

            addTableHeader(tableBody);

            for (var i = 0; i < data.length; i++) {
                var entry = data[i];

                var tr = document.createElement('tr');

                var td = document.createElement('td');
                td.appendChild(document.createTextNode(new Date(entry.time).toString()));
                tr.appendChild(td);

                var td = buildRequestCell(entry.request, i);
                tr.appendChild(td);

                if (!!entry.request.requestBody) {
                    var td = buildRequestBodyCell(entry.request, i);
                    tr.appendChild(td);
                } else {
                    var td = document.createElement('td');
                    td.appendChild(document.createTextNode(""));
                    tr.appendChild(td);
                }

                var td = buildStatusCodeCell(entry.response.statusCode);
                tr.appendChild(td);

                if (JSON.parse(entry.response.responseBody).error != null) {
                    var td = document.createElement('td');
                    td.appendChild(document.createTextNode(""));
                    tr.appendChild(td);

                    var td = buildErrorCell(entry.response.responseBody, i);
                    tr.appendChild(td);
                } else {
                    var td = buildResponseBodyCell(entry.response, i);
                    tr.appendChild(td);

                    var td = document.createElement('td');
                    td.appendChild(document.createTextNode(""));
                    tr.appendChild(td);
                }

                tableBody.appendChild(tr);
            }
            // table.appendChild(tableBody);
            // body.appendChild(table);

            return tableBody;
        }

        function addTableHeader(tableBody) {
            var listTableHeaders = ['Time', 'Request', 'Body', 'Status', 'Response', 'Error'];

            var tr = document.createElement('tr');

            listTableHeaders.forEach(function (columnHead) {
                var th = document.createElement('th');
                th.appendChild(document.createTextNode(columnHead));
                tr.appendChild(th);
            });

            tableBody.appendChild(tr);

        }

        function buildRequestCell(request, index) {
            var td = document.createElement('td');

            td.appendChild(
                document.createTextNode(request.httpMethod + " " + getLocation(
                    request.uri).pathname));

            var requestHeaderSpan = document.createElement('span');
            requestHeaderSpan.setAttribute('onclick',
                "showPopup('Headers', 'log_head_" + index + "')");
            var br = document.createElement('br');
            requestHeaderSpan.appendChild(br);
            requestHeaderSpan.appendChild(document.createTextNode('(headers)'));
            td.appendChild(requestHeaderSpan);

            var requestHeaderParagraph = document.createElement('p');
            requestHeaderParagraph.setAttribute('id', 'log_head_' + index);
            requestHeaderParagraph.appendChild(
                document.createTextNode(JSON.stringify(request.httpHeaders, null, 2)));

            td.appendChild(requestHeaderParagraph);

            return td;
        }

        function buildRequestBodyCell(request, index) {
            var td = document.createElement('td');

            var requestBodySpan = document.createElement('span');
            requestBodySpan.setAttribute('onclick',
                "showPopup('RequestBody', 'log_request_body_" + index + "')");
            requestBodySpan.appendChild(document.createTextNode('(request body)'));
            td.appendChild(requestBodySpan);

            var requestBodyParagraph = document.createElement('p');
            requestBodyParagraph.setAttribute('id', 'log_request_body_' + index);
            requestBodyParagraph.appendChild(document.createTextNode(
                JSON.parse(JSON.stringify(request.requestBody, null, 2))));

            td.appendChild(requestBodyParagraph);

            return td;
        }

        function buildStatusCodeCell(statusCode) {
            var td = document.createElement('td');
            var statusCodeDiv = document.createElement('div');
            statusCode < 400 ? statusCodeDiv.setAttribute('style', 'color: green;')
                             : statusCodeDiv.setAttribute('style', 'color: red;');
            statusCodeDiv.appendChild(document.createTextNode(statusCode));
            td.appendChild(statusCodeDiv);

            return td;
        }

        function buildResponseBodyCell(response, index) {
            var td = document.createElement('td');

            var responseBodySpan = document.createElement('span');
            responseBodySpan.setAttribute('onclick',
                "showPopup('ResponseBody', 'log_response_body_" + index + "')");
            responseBodySpan.appendChild(document.createTextNode('(response body)'));
            td.appendChild(responseBodySpan);

            var responseBodyParagraph = document.createElement('p');
            responseBodyParagraph.setAttribute('id', 'log_response_body_' + index);
            responseBodyParagraph.appendChild(document.createTextNode(
                JSON.parse(JSON.stringify(response.responseBody, null, 2))));

            td.appendChild(responseBodyParagraph);

            return td;
        }

        function buildErrorCell(error, index) {
            var td = document.createElement('td');

            var errorJson = JSON.parse(error);

            td.appendChild(document.createTextNode(errorJson.error));
            td.appendChild(document.createElement('br'));

            td.appendChild(document.createTextNode(errorJson.exception));
            td.appendChild(document.createElement('br'));

            var errorSpan = document.createElement('span');
            errorSpan.setAttribute('onclick',
                "showPopup('Error', 'log_error_" + index + "');");
            errorSpan.appendChild(document.createTextNode('>>'));
            td.appendChild(errorSpan);

            var errorParagraph = document.createElement('p');
            errorParagraph.setAttribute('id', 'log_error_' + index);
            errorParagraph.innerHTML = JSON.stringify(JSON.parse(error), undefined, '\t');

            td.appendChild(errorParagraph);

            return td;
        }

        function getLocation(href) {
            var l = document.createElement("a");
            l.href = href;

            return l;
        }
    </script>
</head>
<body>
<label for="integration_log">Time Interval: </label>
<form id="integration_log" onsubmit="submitForm()">
    <input id="from" placeholder="from">
    -
    <input id="to" placeholder="to">
    <input id="view" type="submit" value="View">
</form>
<div id="popupModal" class="modal">
    <div class="modal-content">
        <div class="modal-header"><span class="modal-close"
                                        onclick="document.getElementById('popupModal').style.display = 'none';">Ã—</span>
            <h3 id="popupHeader"></h3></div>
        <div class="modal-body">
            <pre id="popupDescr"></pre>
        </div>
    </div>
</div>


<script type="text/javascript">
    $('#from').datetimepicker();
    $('#to').datetimepicker();

    $("#integration_log").submit(function (e) {
        e.preventDefault();
    });
</script>

<style type="text/css">
    p {
        display: none;
    }

    span {
        color: blue;
        cursor: pointer;
    }

    table {
        width: 100%;
        border-width: 0;
        border-spacing: 0;
        border-collapse: collapse;
    }

    tr {
        border-color: #ccc;
        border-style: solid;
        border-width: 1px 0 1px 0;
        border-spacing: 0;
    }

    td, th {
        margin: 0;
        padding: 4px 10px 4px 10px;
        border-color: #666;
        border-style: solid;
        border-width: 0;
        font-family: Consolas, monaco, monospace;
        font-size: small;
        text-align: left;
    }
</style>
<style type="text/css">
    .modal {
        display: none; /* Hidden by default */
        position: fixed; /* Stay in place */
        z-index: 1; /* Sit on top */
        left: 0;
        top: 0;
        width: 100%; /* Full width */
        height: 100%; /* Full height */
        overflow: auto; /* Enable scroll if needed */
        background-color: rgb(0, 0, 0); /* Fallback color */
        background-color: rgba(0, 0, 0, 0.4); /* Black w/ opacity */
    }

    .modal-header {
        padding: 2px 16px;
        background-color: #1c36ff;
        color: white;
        overflow-x: auto;
    }

    .modal-body {
        padding: 2px 16px;
        overflow-x: auto;
    }

    .modal-content {
        position: relative;
        background-color: #fefefe;
        margin: 15% auto;
        padding: 0;
        border: 1px solid #888;
        width: 70%;
    }

    .modal-close {
        color: white;
        float: right;
        font-size: 24px;
        font-weight: bold;
    }

    .modal-close:hover,
    .modal-close:focus {
        color: red;
        text-decoration: none;
        cursor: pointer;
    }

    .errorMsg {
        color: red;
    }
</style>

</body>
</html>